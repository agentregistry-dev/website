{{ $meeting := .Site.Data.community.meeting }}

<a href="#community-meeting"
   class="meeting-indicator-compact flex items-center gap-2 px-3 py-2 bg-tertiary-text/20 border-2 border-tertiary-text rounded-lg hover:bg-tertiary-text/30 transition-all duration-200 text-sm"
   id="compactMeetingIndicator"
   title="View community meeting details">
  <div class="compact-status-dot w-2 h-2 rounded-full bg-tertiary-text" id="compactStatusDot"></div>
  <span class="compact-status-text text-primary-text whitespace-nowrap font-medium" id="compactStatusText">Community Meeting</span>
  <svg class="w-4 h-4 text-tertiary-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
  </svg>
</a>

<script>
(function() {
  function updateCompactMeetingStatus() {
    const now = new Date();
    const etTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
    const day = etTime.getDay();
    const hours = etTime.getHours();
    const minutes = etTime.getMinutes();
    const currentMinutes = hours * 60 + minutes;

    const meetingDay = 4; // Thursday
    const meetingStart = 14 * 60; // 2pm
    const meetingEnd = 15 * 60; // 3pm

    const statusDot = document.getElementById('compactStatusDot');
    const statusText = document.getElementById('compactStatusText');
    const indicator = document.getElementById('compactMeetingIndicator');

    if (!statusDot || !statusText || !indicator) return;

    // Meeting is happening NOW
    if (day === meetingDay && currentMinutes >= meetingStart && currentMinutes < meetingEnd) {
      statusDot.className = 'compact-status-dot w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-lg shadow-green-500/50';
      statusText.className = 'compact-status-text text-green-400 whitespace-nowrap font-medium';
      statusText.textContent = 'Live Now!';
      indicator.className = 'meeting-indicator-compact flex items-center gap-2 px-3 py-2 bg-green-500/10 border border-green-500/50 rounded-lg hover:border-green-500 transition-all duration-200 text-sm animate-pulse';
      return;
    }

    // Calculate next meeting
    let daysUntilMeeting = meetingDay - day;
    if (daysUntilMeeting < 0 || (daysUntilMeeting === 0 && currentMinutes >= meetingEnd)) {
      daysUntilMeeting += 7;
    }

    // Meeting is today but hasn't started
    if (day === meetingDay && currentMinutes < meetingStart) {
      const minutesUntil = meetingStart - currentMinutes;
      const hoursUntil = Math.floor(minutesUntil / 60);
      const minsUntil = minutesUntil % 60;

      statusDot.className = 'compact-status-dot w-2 h-2 rounded-full bg-yellow-500 animate-pulse shadow-lg shadow-yellow-500/50';
      statusText.className = 'compact-status-text text-white whitespace-nowrap font-medium';

      if (hoursUntil > 0) {
        statusText.textContent = `Starts in ${hoursUntil}h ${minsUntil}m`;
      } else {
        statusText.textContent = `Starts in ${minsUntil}m`;
      }
      indicator.className = 'meeting-indicator-compact flex items-center gap-2 px-3 py-2 bg-yellow-500/10 border border-yellow-500/50 rounded-lg hover:border-yellow-500 transition-all duration-200 text-sm';
      return;
    }

    // Meeting is in the future - show countdown
    statusDot.className = 'compact-status-dot w-2 h-2 rounded-full bg-tertiary-text';
    statusText.className = 'compact-status-text text-primary-text whitespace-nowrap font-medium';

    // Calculate exact time until next meeting
    const nextMeetingDate = new Date(etTime);
    nextMeetingDate.setDate(nextMeetingDate.getDate() + daysUntilMeeting);
    nextMeetingDate.setHours(14, 0, 0, 0); // 2pm

    const timeUntilMeeting = nextMeetingDate - etTime;
    const daysLeft = Math.floor(timeUntilMeeting / (1000 * 60 * 60 * 24));
    const hoursLeft = Math.floor((timeUntilMeeting % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutesLeft = Math.floor((timeUntilMeeting % (1000 * 60 * 60)) / (1000 * 60));

    if (daysLeft > 0) {
      statusText.textContent = `Join ${daysLeft}d ${hoursLeft}h ${minutesLeft}m`;
    } else if (hoursLeft > 0) {
      statusText.textContent = `Join ${hoursLeft}h ${minutesLeft}m`;
    } else {
      statusText.textContent = `Join ${minutesLeft}m`;
    }

    indicator.className = 'meeting-indicator-compact flex items-center gap-2 px-3 py-2 bg-tertiary-text/20 border-2 border-tertiary-text rounded-lg hover:bg-tertiary-text/30 transition-all duration-200 text-sm';
  }

  // Update immediately and then every 30 seconds
  updateCompactMeetingStatus();
  setInterval(updateCompactMeetingStatus, 30000);
})();
</script>

<style>
.meeting-indicator-compact {
  transition: all 0.2s ease;
}

.meeting-indicator-compact:hover {
  transform: translateY(-1px);
}
</style>
